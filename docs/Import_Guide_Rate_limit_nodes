# How to Import Rate Limiting & Switch Nodes into Your Workflow

## ğŸ“¥ Step-by-Step Import Instructions

### Step 1: Download the JSON File

Download: `n8n-rate-limit-nodes-import.json`

---

### Step 2: Import into n8n

1. Open your n8n workflow
2. Click the **"..." menu** (top right, next to Execute Workflow)
3. Select **"Import from File"**
4. Choose the downloaded `n8n-rate-limit-nodes-import.json` file
5. Click **"Import"**

**Result:** You'll see 5 new nodes appear in a separate workflow tab:
- Check & Increment Rate Limit (Code)
- Increment Burst Counter (Redis)
- Increment Hourly Counter (Redis)
- Rate Limit OK? (IF)
- Text or Media? (Switch)

---

### Step 3: Copy Nodes to Your Main Workflow

**In the new imported workflow:**
1. Select all 5 nodes (Ctrl+A or Cmd+A)
2. Copy them (Ctrl+C or Cmd+C)

**In your main WhatsApp workflow:**
1. Click on the main workflow tab
2. Paste the nodes (Ctrl+V or Cmd+V)
3. Position them where you need them

---

### Step 4: Delete Old Nodes from Your Workflow

**Remove these old nodes:**
- âŒ Old "Check Rate Limit" (Redis GET)
- âŒ Old "Increment Rate Counter" (Redis INCREMENT)
- âŒ Old "Text or Media?" (if broken)

---

### Step 5: Connect the New Nodes

**Connections you need to make:**

```
Extract Message Data
    â†“
Check & Increment Rate Limit (NEW)
    â†“ (splits to 2 outputs)
    â”œâ”€> Increment Burst Counter (NEW)
    â”‚       â†“
    â””â”€> Increment Hourly Counter (NEW)
            â†“
        (Both feed into)
            â†“
    Rate Limit OK? (NEW)
        â”œâ”€ TRUE (Output 1) â†’ Text or Media? (NEW)
        â””â”€ FALSE (Output 2) â†’ Rate Limit Response (your existing node)

Text or Media? (NEW)
    â”œâ”€ Output 0 (Text) â†’ Get Conversation History
    â”œâ”€ Output 1 (Audio) â†’ Download Audio
    â”œâ”€ Output 2 (Image) â†’ Download Image
    â””â”€ Output 3 (Document) â†’ Skip or handle
```

---

### Step 6: Configure Redis Credentials

**For both Redis nodes:**

1. Click **"Increment Burst Counter"** node
2. Under **"Credential to connect with"**
3. Select your **"Railway Redis Production"** credential
4. If you don't see it, create it:
   - Click "Create New Credential"
   - Name: `Railway Redis Production`
   - Host: `redis.railway.internal`
   - Port: `6379`
   - Password: (from Railway)
   - Database: `0`
   - SSL: No
   - Save

5. Repeat for **"Increment Hourly Counter"** node

---

### Step 7: Test the Configuration

**Test 1: Normal Message**
- Send "Hello" from WhatsApp
- Should process normally âœ…

**Test 2: Rate Limit**
- Send 6 messages rapidly
- 6th message should be blocked âŒ
- Should receive rate limit message

**Test 3: Switch Node**
- Send text: "Hi" â†’ Goes to Output 0 âœ…
- Send audio: â†’ Goes to Output 1 âœ…
- Send image: â†’ Goes to Output 2 âœ…

---

## ğŸ”§ Troubleshooting

### Issue: "Node 'Increment Burst Counter' not found"

**Fix:** The IF node is looking for the wrong node name.

**In "Rate Limit OK?" node:**
1. Click to edit
2. Conditions â†’ First condition
3. Left Value should be: `={{$node['Increment Burst Counter'].json.value}}`
4. Right Value should be: `={{$node['Check & Increment Rate Limit'].json.burstLimit}}`

### Issue: Redis credentials not working

**Fix:**
1. Go to Railway â†’ Redis service
2. Copy the connection URL
3. Extract: Host, Port, Password
4. Update credentials in n8n

### Issue: Switch node "No output data"

**Fix:** The messageType field might be missing.

**Check "Extract Message Data" node outputs:**
- Should have: `messageType: "text"` or `"audio"` etc.
- If missing, the Switch won't match

---

## ğŸ“Š Visual Connection Guide

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Extract Message Data           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check & Increment Rate Limit   â”‚  (Code - Prepares data)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ (splits)
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                        â”‚
           â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Increment Burst      â”‚  â”‚ Increment Hourly     â”‚  (Redis - Atomic +1)
â”‚ Counter              â”‚  â”‚ Counter              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (both feed in)
                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  Rate Limit OK?      â”‚  (IF - Check limits)
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ TRUE                  â”‚ FALSE
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Text or Media?      â”‚  â”‚ Rate Limit Response  â”‚
â”‚  (Switch)            â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚         â”‚         â”‚
  Output 0    Output 1  Output 2  Output 3
  (Text)      (Audio)   (Image)   (Doc)
     â”‚           â”‚         â”‚         â”‚
     â–¼           â–¼         â–¼         â–¼
  Continue   Download  Download     Skip
             Audio     Image
```

---

## âœ… Verification Checklist

After import and connection:

- [ ] All 5 nodes visible in workflow
- [ ] Redis credentials configured on both Redis nodes
- [ ] "Check & Increment Rate Limit" connected to "Extract Message Data"
- [ ] "Check & Increment Rate Limit" splits to both Redis nodes
- [ ] Both Redis nodes connect to "Rate Limit OK?"
- [ ] "Rate Limit OK?" TRUE â†’ "Text or Media?"
- [ ] "Rate Limit OK?" FALSE â†’ Rate Limit Response
- [ ] "Text or Media?" Output 0 â†’ Get Conversation History (or next node)
- [ ] Workflow saved
- [ ] Test message sent successfully

---

## ğŸ¯ What These Nodes Do

### 1. Check & Increment Rate Limit (Code)
**Purpose:** Prepares rate limiting data
**Output:** Keys for Redis, limits, and pass-through data

### 2. Increment Burst Counter (Redis)
**Purpose:** Atomic increment of 30-second counter
**Output:** Current count (e.g., 1, 2, 3... up to 5)

### 3. Increment Hourly Counter (Redis)
**Purpose:** Atomic increment of 1-hour counter
**Output:** Current count (e.g., 1, 2, 3... up to 100)

### 4. Rate Limit OK? (IF)
**Purpose:** Check if both limits are OK
**Condition 1:** Burst count â‰¤ 5
**Condition 2:** Hourly count â‰¤ 100
**Output:** TRUE (continue) or FALSE (block)

### 5. Text or Media? (Switch)
**Purpose:** Route based on message type
**Output 0:** Text messages
**Output 1:** Audio messages
**Output 2:** Image messages
**Output 3:** Document messages

---

## ğŸš€ After Import Success

Once working:
1. Test with real WhatsApp messages
2. Monitor Redis in Railway (check keys being created)
3. Test rate limiting (send 6 messages fast)
4. Continue to next section (AI agents)

---

## ğŸ’¡ Pro Tips

1. **Import into a new workflow first** to see how nodes should be configured
2. **Take screenshots** of node configurations before modifying
3. **Test one node at a time** by using "Execute Node" button
4. **Check executions** in left sidebar to debug issues
5. **Use "Test workflow"** to manually trigger with sample data

---

## ğŸ†˜ Still Having Issues?

If you're still stuck after import:

1. **Screenshot the error** you're seeing
2. **Show me the node configuration** that's failing
3. **Share the execution log** from n8n
4. **Tell me which step failed** in the import process

I'll help you debug! ğŸš€
