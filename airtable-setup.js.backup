// Airtable Autonomous Setup Script
// This script automatically creates all necessary tables and fields in your Airtable base
// Run this once to set up your database structure

const Airtable = require('airtable');
require('dotenv').config();

class AirtableAutoSetup {
  constructor() {
    this.airtable = new Airtable({ apiKey: process.env.AIRTABLE_API_KEY });
    this.base = this.airtable.base(process.env.AIRTABLE_BASE_ID);
  }

  async setupDatabase() {
    console.log('ğŸš€ Starting Airtable database setup...\n');

    try {
      // Create all tables
      await this.createCustomersTable();
      await this.createServicesTable();
      await this.createBookingsTable();
      await this.createBusinessSettingsTable();
      
      // Add default data
      await this.addDefaultServices();
      await this.addDefaultSettings();

      console.log('\nâœ… Database setup complete!');
      console.log('ğŸ“Š Your Airtable base is ready to use.');
      
    } catch (error) {
      console.error('âŒ Error during setup:', error.message);
      console.log('\nğŸ’¡ If tables already exist, this is normal. They won\'t be duplicated.');
    }
  }

  async createCustomersTable() {
    console.log('ğŸ“‹ Creating Customers table...');
    
    // Note: Airtable API doesn't support programmatic table creation
    // This is a template for the structure. Tables should be created via Airtable UI
    // or we provide SQL-like schema for manual creation
    
    const schema = {
      name: 'Customers',
      fields: [
        { name: 'name', type: 'singleLineText' },
        { name: 'phone_number', type: 'phoneNumber' },
        { name: 'email', type: 'email' },
        { name: 'total_bookings', type: 'number', options: { precision: 0 } },
        { name: 'total_spent', type: 'currency', options: { precision: 2, symbol: '$' } },
        { name: 'last_booking_date', type: 'date' },
        { name: 'created_at', type: 'dateTime' },
        { name: 'notes', type: 'multilineText' },
        { name: 'preferred_services', type: 'multipleSelects' },
        { name: 'birthday', type: 'date' },
        { name: 'referral_source', type: 'singleSelect', options: {
          choices: [
            { name: 'WhatsApp' },
            { name: 'Walk-in' },
            { name: 'Social Media' },
            { name: 'Referral' },
            { name: 'Google' },
            { name: 'Other' }
          ]
        }}
      ]
    };

    // Check if table exists by trying to read from it
    try {
      const records = await this.base('Customers').select({ maxRecords: 1 }).firstPage();
      console.log('âœ… Customers table already exists');
    } catch (error) {
      console.log('â„¹ï¸  Customers table needs to be created manually in Airtable');
      console.log('   Use this schema:', JSON.stringify(schema, null, 2));
    }
  }

  async createServicesTable() {
    console.log('ğŸ“‹ Creating Services table...');
    
    const schema = {
      name: 'Services',
      fields: [
        { name: 'name', type: 'singleLineText' },
        { name: 'description', type: 'multilineText' },
        { name: 'duration', type: 'number', options: { precision: 0 } },
        { name: 'price', type: 'currency', options: { precision: 2, symbol: '$' } },
        { name: 'category', type: 'singleSelect', options: {
          choices: [
            { name: 'Nails' },
            { name: 'Hair' },
            { name: 'Facial' },
            { name: 'Massage' },
            { name: 'Waxing' },
            { name: 'Other' }
          ]
        }},
        { name: 'archived', type: 'checkbox' },
        { name: 'created_at', type: 'dateTime' },
        { name: 'image_url', type: 'url' }
      ]
    };

    try {
      const records = await this.base('Services').select({ maxRecords: 1 }).firstPage();
      console.log('âœ… Services table already exists');
    } catch (error) {
      console.log('â„¹ï¸  Services table needs to be created manually in Airtable');
      console.log('   Use this schema:', JSON.stringify(schema, null, 2));
    }
  }

  async createBookingsTable() {
    console.log('ğŸ“‹ Creating Bookings table...');
    
    const schema = {
      name: 'Bookings',
      fields: [
        { name: 'customer_id', type: 'multipleRecordLinks', options: { linkedTableId: 'Customers' } },
        { name: 'customer_name', type: 'singleLineText' },
        { name: 'customer_phone', type: 'phoneNumber' },
        { name: 'booked_by', type: 'singleLineText' },
        { name: 'booked_by_phone', type: 'phoneNumber' },
        { name: 'service', type: 'singleLineText' },
        { name: 'service_id', type: 'multipleRecordLinks', options: { linkedTableId: 'Services' } },
        { name: 'date_time', type: 'dateTime' },
        { name: 'duration', type: 'number', options: { precision: 0 } },
        { name: 'price', type: 'currency', options: { precision: 2, symbol: '$' } },
        { name: 'status', type: 'singleSelect', options: {
          choices: [
            { name: 'confirmed', color: 'greenBright' },
            { name: 'cancelled', color: 'redBright' },
            { name: 'completed', color: 'blueBright' },
            { name: 'no-show', color: 'orangeBright' },
            { name: 'rescheduled', color: 'yellowBright' }
          ]
        }},
        { name: 'google_event_id', type: 'singleLineText' },
        { name: 'cancellation_reason', type: 'multilineText' },
        { name: 'created_at', type: 'dateTime' },
        { name: 'cancelled_at', type: 'dateTime' },
        { name: 'completed_at', type: 'dateTime' },
        { name: 'notes', type: 'multilineText' },
        { name: 'reminder_sent', type: 'checkbox' }
      ]
    };

    try {
      const records = await this.base('Bookings').select({ maxRecords: 1 }).firstPage();
      console.log('âœ… Bookings table already exists');
    } catch (error) {
      console.log('â„¹ï¸  Bookings table needs to be created manually in Airtable');
      console.log('   Use this schema:', JSON.stringify(schema, null, 2));
    }
  }

  async createBusinessSettingsTable() {
    console.log('ğŸ“‹ Creating BusinessSettings table...');
    
    const schema = {
      name: 'BusinessSettings',
      fields: [
        { name: 'business_name', type: 'singleLineText' },
        { name: 'business_hours', type: 'multilineText' },
        { name: 'business_hours_json', type: 'multilineText' },
        { name: 'booking_limit', type: 'number', options: { precision: 0 } },
        { name: 'timezone', type: 'singleLineText' },
        { name: 'owner_phone', type: 'phoneNumber' },
        { name: 'owner_email', type: 'email' },
        { name: 'rate_limit', type: 'number', options: { precision: 0 } },
        { name: 'address', type: 'multilineText' },
        { name: 'website', type: 'url' },
        { name: 'social_media', type: 'multilineText' },
        { name: 'cancellation_policy', type: 'multilineText' },
        { name: 'deposit_required', type: 'checkbox' },
        { name: 'deposit_amount', type: 'currency', options: { precision: 2, symbol: '$' } },
        { name: 'auto_confirm_bookings', type: 'checkbox' },
        { name: 'created_at', type: 'dateTime' },
        { name: 'updated_at', type: 'dateTime' }
      ]
    };

    try {
      const records = await this.base('BusinessSettings').select({ maxRecords: 1 }).firstPage();
      console.log('âœ… BusinessSettings table already exists');
    } catch (error) {
      console.log('â„¹ï¸  BusinessSettings table needs to be created manually in Airtable');
      console.log('   Use this schema:', JSON.stringify(schema, null, 2));
    }
  }

  async addDefaultServices() {
    console.log('\nğŸ“¦ Adding default services...');

    const defaultServices = [
      {
        name: 'Classic Manicure',
        description: 'Traditional nail care with polish',
        duration: 45,
        price: 30,
        category: 'Nails',
        archived: false,
        created_at: new Date().toISOString()
      },
      {
        name: 'Gel Manicure',
        description: 'Long-lasting gel polish manicure',
        duration: 60,
        price: 45,
        category: 'Nails',
        archived: false,
        created_at: new Date().toISOString()
      },
      {
        name: 'Classic Pedicure',
        description: 'Relaxing foot care with polish',
        duration: 60,
        price: 40,
        category: 'Nails',
        archived: false,
        created_at: new Date().toISOString()
      },
      {
        name: 'Gel Pedicure',
        description: 'Long-lasting gel polish pedicure',
        duration: 75,
        price: 55,
        category: 'Nails',
        archived: false,
        created_at: new Date().toISOString()
      },
      {
        name: 'Acrylic Full Set',
        description: 'Full set of acrylic nails',
        duration: 120,
        price: 65,
        category: 'Nails',
        archived: false,
        created_at: new Date().toISOString()
      },
      {
        name: 'Acrylic Fill',
        description: 'Acrylic nail fill maintenance',
        duration: 90,
        price: 45,
        category: 'Nails',
        archived: false,
        created_at: new Date().toISOString()
      },
      {
        name: 'Nail Art (per nail)',
        description: 'Custom nail art design',
        duration: 10,
        price: 5,
        category: 'Nails',
        archived: false,
        created_at: new Date().toISOString()
      }
    ];

    try {
      // Check if services already exist
      const existing = await this.base('Services').select({ maxRecords: 1 }).firstPage();
      
      if (existing.length > 0) {
        console.log('â„¹ï¸  Services already exist, skipping default services');
        return;
      }

      // Add services one by one
      for (const service of defaultServices) {
        await this.base('Services').create(service);
        console.log(`  âœ“ Added: ${service.name}`);
      }

      console.log('âœ… Default services added successfully');
    } catch (error) {
      console.log('âš ï¸  Could not add default services:', error.message);
      console.log('   You can add them manually via WhatsApp or Airtable UI');
    }
  }

  async addDefaultSettings() {
    console.log('\nâš™ï¸  Adding default business settings...');

    const defaultSettings = {
      business_name: 'Your Salon Name',
      business_hours: 'Mon-Fri: 9:00 AM - 6:00 PM\nSat: 10:00 AM - 5:00 PM\nSun: Closed',
      business_hours_json: JSON.stringify({
        Monday: { open: '09:00', close: '18:00' },
        Tuesday: { open: '09:00', close: '18:00' },
        Wednesday: { open: '09:00', close: '18:00' },
        Thursday: { open: '09:00', close: '18:00' },
        Friday: { open: '09:00', close: '18:00' },
        Saturday: { open: '10:00', close: '17:00' },
        Sunday: { closed: true }
      }),
      booking_limit: 6,
      timezone: 'America/New_York',
      rate_limit: 30,
      cancellation_policy: 'Please provide at least 24 hours notice for cancellations. Late cancellations may incur a fee.',
      deposit_required: false,
      auto_confirm_bookings: true,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    try {
      // Check if settings already exist
      const existing = await this.base('BusinessSettings').select({ maxRecords: 1 }).firstPage();
      
      if (existing.length > 0) {
        console.log('â„¹ï¸  Business settings already exist');
        return;
      }

      await this.base('BusinessSettings').create(defaultSettings);
      console.log('âœ… Default business settings added');
      console.log('   Remember to update these with your actual business information!');
    } catch (error) {
      console.log('âš ï¸  Could not add default settings:', error.message);
      console.log('   You can add them manually in Airtable');
    }
  }

  async verifySetup() {
    console.log('\nğŸ” Verifying database setup...\n');

    const tables = ['Customers', 'Services', 'Bookings', 'BusinessSettings'];
    const results = {};

    for (const table of tables) {
      try {
        const records = await this.base(table).select({ maxRecords: 1 }).firstPage();
        results[table] = { exists: true, recordCount: records.length };
        console.log(`âœ… ${table}: OK`);
      } catch (error) {
        results[table] = { exists: false, error: error.message };
        console.log(`âŒ ${table}: Not found`);
      }
    }

    return results;
  }

  async exportTableSchemas() {
    console.log('\nğŸ“„ Exporting table schemas for manual setup...\n');

    const schemas = {
      Customers: {
        fields: [
          'name (Single line text)',
          'phone_number (Phone number)',
          'email (Email)',
          'total_bookings (Number)',
          'total_spent (Currency - $)',
          'last_booking_date (Date)',
          'created_at (Date)',
          'notes (Long text)',
          'preferred_services (Multiple select)',
          'birthday (Date)',
          'referral_source (Single select: WhatsApp, Walk-in, Social Media, Referral, Google, Other)'
        ]
      },
      Services: {
        fields: [
          'name (Single line text)',
          'description (Long text)',
          'duration (Number - minutes)',
          'price (Currency - $)',
          'category (Single select: Nails, Hair, Facial, Massage, Waxing, Other)',
          'archived (Checkbox)',
          'created_at (Date)',
          'image_url (URL)'
        ]
      },
      Bookings: {
        fields: [
          'customer_id (Link to Customers table)',
          'customer_name (Single line text)',
          'customer_phone (Phone number)',
          'booked_by (Single line text)',
          'booked_by_phone (Phone number)',
          'service (Single line text)',
          'service_id (Link to Services table)',
          'date_time (Date with time)',
          'duration (Number - minutes)',
          'price (Currency - $)',
          'status (Single select: confirmed, cancelled, completed, no-show, rescheduled)',
          'google_event_id (Single line text)',
          'cancellation_reason (Long text)',
          'created_at (Date)',
          'cancelled_at (Date)',
          'completed_at (Date)',
          'notes (Long text)',
          'reminder_sent (Checkbox)'
        ]
      },
      BusinessSettings: {
        fields: [
          'business_name (Single line text)',
          'business_hours (Long text)',
          'business_hours_json (Long text)',
          'booking_limit (Number)',
          'timezone (Single line text)',
          'owner_phone (Phone number)',
          'owner_email (Email)',
          'rate_limit (Number)',
          'address (Long text)',
          'website (URL)',
          'social_media (Long text)',
          'cancellation_policy (Long text)',
          'deposit_required (Checkbox)',
          'deposit_amount (Currency - $)',
          'auto_confirm_bookings (Checkbox)',
          'created_at (Date)',
          'updated_at (Date)'
        ]
      }
    };

    console.log('Copy these table structures to create them manually in Airtable:\n');
    console.log(JSON.stringify(schemas, null, 2));
    
    return schemas;
  }
}

// Main execution
async function main() {
  const setup = new AirtableAutoSetup();
  
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘   Salon WhatsApp Bot - Airtable Auto Setup            â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  // Run setup
  await setup.setupDatabase();

  // Verify
  console.log('\n' + '='.repeat(60));
  await setup.verifySetup();

  // Export schemas for manual creation if needed
  console.log('\n' + '='.repeat(60));
  await setup.exportTableSchemas();

  console.log('\nâœ¨ Setup process complete!');
  console.log('\nğŸ“‹ Next steps:');
  console.log('1. Verify all tables exist in your Airtable base');
  console.log('2. Update BusinessSettings with your actual information');
  console.log('3. Add or modify services as needed');
  console.log('4. Import the n8n workflow');
  console.log('5. Configure credentials in n8n');
  console.log('6. Start the MCP server');
  console.log('7. Test your bot!\n');
}

// Run if called directly
if (require.main === module) {
  main().catch(console.error);
}

module.exports = AirtableAutoSetup;
